<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CO2 Emisije u Europi</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 20px;
    }

    h1, h2 {
      color: #333;
      margin-top: 0;
      text-align: center;
    }

    .row {
      display: flex;
      justify-content: center;
      gap: 30px;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }

    .chart-box {
      flex: 1 1 45%;
      max-width: 900px;
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 8px;
      padding: 24px;
      box-sizing: border-box;
    }

    .svg-container {
      width: 100%;
      height: auto;
      aspect-ratio: 16 / 10;
    }

    @media (max-width: 1000px) {
      .chart-box {
        flex: 1 1 100%;
        max-width: 100%;
      }
    }

    .tooltip {
      position: absolute;
      text-align: left;
      padding: 8px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      pointer-events: none;
      font-size: 15px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }

    #filters {
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
    }

    select {
      padding: 5px 10px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }

    .basic-comparison-container {
      display: flex;
      gap: 40px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .basic-box {
      background: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.07);
      padding: 24px 32px;
      min-width: 280px;
      flex: 1;
      max-width: 400px;
    }

    .param-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 17px;
    }

    .param-row .param-label {
      color: #555;
    }

    .param-row .param-value {
      font-weight: bold;
      color: #222;
    }

    .zoom-controls {
      margin-bottom: 10px;
    }

    .zoom-btn {
      display: inline-block;
      margin-right: 5px;
      background: #e0e0e0;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
    }

    #play-animation {
      padding: 5px 15px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #play-animation:hover {
      background: #45a049;
    }

    #year-display {
      font-weight: bold;
      font-size: 18px;
      min-width: 50px;
      text-align: center;
    }
    /* Sidebar panel */
.country-sidebar {
  position: fixed;
  top: 0;
  right: -500px;
  width: 500px;
  height: 100vh;
  background: white;
  box-shadow: -5px 0 15px rgba(0,0,0,0.3);
  transition: right 0.3s ease;
  z-index: 1000;
  overflow-y: auto;
  padding: 20px;
  box-sizing: border-box;
}

.country-sidebar.open {
  right: 0;
}

.sidebar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #eee;
}

.close-sidebar {
  background: #ff4444;
  color: white;
  border: none;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  cursor: pointer;
  font-size: 18px;
}

.sidebar-chart {
  margin-bottom: 30px;
  background: #f9f9f9;
  padding: 15px;
  border-radius: 8px;
}

.sidebar-chart h3 {
  margin-top: 0;
  color: #333;
  text-align: center;
}

.sidebar-chart svg {
  width: 100%;
  height: 250px;
}

/* Dodaj u <style> sekciju */
.sidebar-chart svg {
  overflow: visible;
}

.arc path {
  cursor: pointer;
  transition: opacity 0.2s;
}

.arc path:hover {
  opacity: 0.8;
}

.dot {
  cursor: pointer;
  transition: r 0.2s;
}

.dot:hover {
  r: 6;
}

.bar {
  cursor: pointer;
  transition: opacity 0.2s;
}

.bar:hover {
  opacity: 0.8;
}

  </style>
</head>
<body>
  <h1>Vizualizacija CO₂ emisija u Europi</h1>
  <div id="filters">
    <label for="yearSelect">Godina:</label>
    <select id="yearSelect"></select>
    <button id="play-animation">Pokreni animaciju</button>
    <div id="year-display">2020</div>
  </div>

  <div class="row">
    <div class="chart-box">
      <div class="zoom-controls">
        <button class="zoom-btn" id="zoom-in">+</button>
        <button class="zoom-btn" id="zoom-out">-</button>
        <button class="zoom-btn" id="zoom-reset">Reset</button>
      </div>
      <svg id="map" class="svg-container" viewBox="0 0 900 550" preserveAspectRatio="xMidYMid meet"></svg>
    </div>
    <div class="chart-box">
      <h2>Trend emisija CO₂ po državi</h2>
      <label for="countryLine1">Država 1:</label>
      <select id="countryLine1"></select>
      <label for="countryLine2">Država 2:</label>
      <select id="countryLine2"></select>
      <svg id="lineChart" class="svg-container" viewBox="0 0 900 550" preserveAspectRatio="xMidYMid meet"></svg>
    </div>
  </div>

  <div class="row">
    <div class="chart-box">
      <h2>5 država sa najvećom emisijom CO₂ u odabranoj godini</h2>
      <svg id="barChart" class="svg-container" viewBox="0 0 900 550" preserveAspectRatio="xMidYMid meet"></svg>
    </div>
    <div class="chart-box">
      <h2>Osnovni podaci za odabrane države</h2>
      <div class="basic-comparison-container" id="basicComparison"></div>
    </div>
  </div>
  <!-- Country Details Sidebar -->
<div id="countrySidebar" class="country-sidebar">
  <div class="sidebar-header">
    <h2 id="selectedCountryName">Detalji države</h2>
    <button class="close-sidebar" onclick="closeCountrySidebar()">×</button>
  </div>
  
  <div class="sidebar-chart">
    <h3>Emisije CO₂ po izvorima</h3>
    <svg id="sourcesPieChart"></svg>
  </div>
  
  <div class="sidebar-chart">
    <h3>CO₂ per capita kroz godine</h3>
    <svg id="perCapitaChart"></svg>
  </div>
  
  <div class="sidebar-chart">
    <h3>Kumulativne emisije</h3>
    <svg id="cumulativeChart"></svg>
  </div>
  
  <div class="sidebar-chart">
    <h3>Staklenički plinovi</h3>
    <svg id="ghgChart"></svg>
  </div>
</div>

  <script>
  
// --- 1. Početne postavke i inicijalizacija SVG elemenata ---

const width = 900;
const height = 550;

// SVG kontejneri za kartu i grafove
const svgMap = d3.select("#map");
const legendContainer = svgMap.append("g")
  .attr("class", "legend-container")
  .attr("transform", `translate(${width - 160}, 20)`);
const svgLine = d3.select("#lineChart");

// Tooltip za prikaz detalja
const tooltip = d3.select("body").append("div")
  .attr("class", "tooltip").style("opacity", 0);

// Projekcija i geoPath za crtanje karte Europe
let projection = d3.geoMercator()
  .center([20, 55]).scale(480).translate([width / 2, height / 2]);
let path = d3.geoPath().projection(projection);

// Mapiranje posebnih imena država (GeoJSON -> CSV)
const nameMap = {
  "Czech Republic": "Czechia",
  "Republic of Moldova": "Moldova",
  "The former Yugoslav Republic of Macedonia": "North Macedonia",
  "Holy See (Vatican City)": "Vatican"
};

// --- 2. Globalne varijable i osnovni parametri ---

let geoDataGlobal, co2DataGlobal, colorScaleGlobal, co2ByCountry = {};
let europeanCountries = [];
let zoom = d3.zoom().scaleExtent([1, 8]).on("zoom", zoomed);
let animationInterval = null;
let isAnimating = false;

// Parametri za osnovne indikatore država
const basicParams = [
  {key: "population", label: "Populacija"},
  {key: "gdp", label: "BDP (USD)"},
  {key: "co2", label: "CO₂ emisije (Mt)"},
  {key: "energy_per_capita", label: "Energija po osobi (kWh)"},
  {key: "consumption_co2", label: "Potrošnja CO₂ (Mt)"},
  {key: "gas_co2", label: "Emisija CO₂ iz plina (Mt)"},
  {key: "share_global_co2", label: "Udio globalne emisije CO₂ (%)"}
];

// --- 3. Zoom funkcionalnost na karti ---

svgMap.call(zoom);

function zoomed(event) {
  const {transform} = event;
  svgMap.selectAll("path.country").attr("transform", transform);
}

function resetZoom() {
  svgMap.transition().duration(750).call(
    zoom.transform,
    d3.zoomIdentity
  );
}

// --- 4. Prikaz i ažuriranje karte Europe ---

function updateMap(selectedYear) {
  // Filtriraj podatke za odabranu godinu
  const europeData = co2DataGlobal.filter(d =>
    +d.year === selectedYear && d.country && !isNaN(+d.co2)
  );
  co2ByCountry = {};
  europeData.forEach(d => co2ByCountry[d.country] = +d.co2);

  // Skaliranje boja prema emisijama
  colorScaleGlobal = d3.scalePow()
    .exponent(0.3)
    .domain([0, 3000])
    .range(["#fff5f0", "#67000d"]);

  // Crtanje i bojanje država na karti
  svgMap.selectAll("path.country")
    .data(geoDataGlobal.features, d => nameMap[d.properties.NAME] || d.properties.NAME)
    .join(
      enter => enter.append("path")
        .attr("class", "country")
        .attr("d", path)
        .attr("fill", d => {
          const name = nameMap[d.properties.NAME] || d.properties.NAME;
          const val = co2ByCountry[name];
          return val ? colorScaleGlobal(val) : "#eee";
        })
        .on("mouseover", handleMouseOver)
        .on("mouseout", handleMouseOut)
        .on("click", handleClick),
      update => update.transition().duration(500)
        .attr("fill", d => {
          const name = nameMap[d.properties.NAME] || d.properties.NAME;
          const val = co2ByCountry[name];
          return val ? colorScaleGlobal(val) : "#eee";
        })
    );

  updateLegend();
  updateBarChart(selectedYear);
  updateBasicComparison();
  d3.select("#year-display").text(selectedYear);
}

// --- 5. Legenda za kartu ---

function updateLegend() {
  legendContainer.selectAll("*").remove();
  const gradient = legendContainer.append("defs").append("linearGradient")
    .attr("id", "gradient")
    .attr("x1", "0%").attr("y1", "100%")
    .attr("x2", "0%").attr("y2", "0%");

  gradient.append("stop").attr("offset", "0%").attr("stop-color", "#fff5f0");
  gradient.append("stop").attr("offset", "100%").attr("stop-color", "#67000d");

  legendContainer.append("rect")
    .attr("width", 20)
    .attr("height", 100)
    .style("fill", "url(#gradient)");

  const axisScale = d3.scaleLinear().domain([0, 3000]).range([100, 0]);
  const axis = d3.axisRight(axisScale).ticks(6).tickFormat(d => `${d} Mt`);
  legendContainer.append("g")
    .attr("transform", "translate(25, 0)")
    .call(axis);

  legendContainer.append("text")
    .attr("x", 0)
    .attr("y", -10)
    .style("text-anchor", "start")
    .style("font-size", "12px")
    .style("font-weight", "bold")
    .text("CO₂ emisije (Mt)");
}

// --- 6. Tooltip i interakcije na karti ---

function handleMouseOver(event, d) {
  const name = nameMap[d.properties.NAME] || d.properties.NAME;
  const value = co2ByCountry[name];
  tooltip.transition().duration(200).style("opacity", .9);
  tooltip.html(`<strong>${name}</strong><br>CO₂: ${value ? value.toFixed(2) + ' Mt' : 'n/a'}`)
    .style("left", (event.pageX + 5) + "px")
    .style("top", (event.pageY - 28) + "px");
}

function handleMouseOut() {
  tooltip.transition().duration(500).style("opacity", 0);
}

function handleClick(event, d) {
  const name = nameMap[d.properties.NAME] || d.properties.NAME;
  d3.select("#countryLine1").property("value", name);
  updateLineChart(name, d3.select("#countryLine2").property("value"));
  updateBasicComparison();

  openCountrySidebar(name);
}

// --- 7. Linijski graf (trend emisija) ---

function updateLineChart(c1, c2) {
  const margin = { top: 60, right: 120, bottom: 80, left: 120 };
  const w = width - margin.left - margin.right;
  const h = height - margin.top - margin.bottom;
  svgLine.selectAll("*").remove();
  const g = svgLine.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  // Priprema podataka za odabrane države
  const countries = [c1, c2].filter(Boolean);
  const data = countries.map(country => ({
    country,
    values: co2DataGlobal.filter(d => d.country === country && !isNaN(+d.co2))
      .filter(d => +d.year >= 1990).map(d => ({ year: +d.year, co2: +d.co2 }))
  }));

  const x = d3.scaleLinear().domain([1990, 2022]).range([0, w]);
  const yMax = d3.max(data, d => d3.max(d.values, v => v.co2));
  const y = d3.scaleLinear().domain([0, yMax * 1.1]).nice().range([h, 0]);
  const line = d3.line().x(d => x(d.year)).y(d => y(d.co2));

  // Osi
  g.append("g")
    .attr("transform", `translate(0,${h})`)
    .call(d3.axisBottom(x).tickFormat(d3.format("d")))
    .append("text")
    .attr("x", w)
    .attr("y", 50)
    .attr("fill", "#000")
    .style("text-anchor", "end")
    .style("font-size", "16px")
    .text("Godina");
  g.append("g")
    .call(d3.axisLeft(y))
    .append("text")
    .attr("transform", "rotate(-90)")
    .attr("y", -70)
    .attr("dy", "0.71em")
    .attr("fill", "#000")
    .style("text-anchor", "end")
    .style("font-size", "16px")
    .text("CO₂ emisije (Mt)");

  // Linije i točke
  const colors = ["#1f77b4", "#d62728"];
  data.forEach((series, i) => {
    g.append("path")
      .datum(series.values)
      .attr("fill", "none")
      .attr("stroke", colors[i])
      .attr("stroke-width", 3)
      .attr("d", line);
    g.selectAll(".dot-" + i)
      .data(series.values)
      .enter().append("circle")
      .attr("class", "dot-" + i)
      .attr("cx", d => x(d.year))
      .attr("cy", d => y(d.co2))
      .attr("r", 4)
      .attr("fill", colors[i])
      .on("mouseover", (event, d) => {
        tooltip.transition().duration(200).style("opacity", .9);
        tooltip.html(`<strong>${series.country}</strong><br>${d.year}: ${d.co2.toFixed(2)} Mt`)
          .style("left", (event.pageX + 5) + "px")
          .style("top", (event.pageY - 28) + "px");
      })
      .on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0));
  });

  // Legenda
  const legend = g.append("g").attr("transform", `translate(${w - 120}, 20)`);
  data.forEach((series, i) => {
    const legendItem = legend.append("g").attr("transform", `translate(0, ${i * 28})`);
    legendItem.append("rect").attr("width", 20).attr("height", 5).attr("y", 9).attr("fill", colors[i]);
    legendItem.append("text").attr("x", 28).attr("y", 14).attr("dy", "0.35em")
      .style("font-size", "15px").text(series.country);
  });
}

// --- 8. Bar chart (top 5 emitera) ---

function updateBarChart(selectedYear) {
  const barSvg = d3.select("#barChart");
  barSvg.selectAll("*").remove();
  const margin = {top: 40, right: 40, bottom: 40, left: 120};
  const data = co2DataGlobal
    .filter(d => 
      +d.year === selectedYear && 
      d.country && 
      !isNaN(+d.co2) && 
      europeanCountries.includes(d.country)
    )
    .sort((a, b) => +b.co2 - +a.co2)
    .slice(0, 5);

  
  const barHeight = 80; 
  const h = barHeight * data.length;
  const w = Math.min(600, window.innerWidth - 80); 


  const y = d3.scaleBand()
    .domain(data.map(d => d.country))
    .range([0, h])
    .padding(0.2);

  const x = d3.scaleLinear()
    .domain([0, d3.max(data, d => +d.co2)])
    .range([0, w]);

  const g = barSvg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  g.append("g").call(d3.axisLeft(y).tickSize(0).tickPadding(10));
  g.append("g")
    .attr("transform", `translate(0,${h})`)
    .call(d3.axisBottom(x).ticks(7))
    .append("text")
    .attr("x", w)
    .attr("y", 35)
    .attr("fill", "#000")
    .style("text-anchor", "end")
    .style("font-size", "16px")
    .text("CO₂ emisije (Mt)");

  g.selectAll(".bar")
    .data(data)
    .enter().append("rect")
    .attr("class", "bar")
    .attr("y", d => y(d.country))
    .attr("height", y.bandwidth())
    .attr("x", 0)
    .attr("width", d => x(+d.co2))
    .attr("fill", "#1f77b4")
    .on("mouseover", (event, d) => {
      tooltip.transition().duration(200).style("opacity", .9);
      tooltip.html(`<strong>${d.country}</strong><br>CO₂: ${(+d.co2).toFixed(2)} Mt`)
        .style("left", (event.pageX + 5) + "px")
        .style("top", (event.pageY - 28) + "px");
    })
    .on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0));

  g.selectAll(".label")
    .data(data)
    .enter().append("text")
    .attr("x", d => x(+d.co2) + 8)
    .attr("y", d => y(d.country) + y.bandwidth()/2)
    .attr("dy", "0.35em")
    .style("font-size", "16px")
    .text(d => (+d.co2).toFixed(1));
}

// --- 9. Prikaz osnovnih podataka za države ---

function getLatestValue(data, country, param, year) {
  const filtered = data.filter(d => d.country === country && d[param] && !isNaN(+d[param]) && +d.year === +year);
  if (filtered.length > 0) {
    let val = +filtered[0][param];
    if (param === "population") return d3.format(",.0f")(val);
    if (param === "gdp") return d3.format(",.0f")(val);
    if (param === "co2") return d3.format(",.2f")(val);
    if (param === "energy_per_capita") return d3.format(",.0f")(val);
    return val;
  }
  const all = data.filter(d => d.country === country && d[param] && !isNaN(+d[param]));
  if (all.length === 0) return "N/A";
  const latest = all.reduce((a, b) => (+a.year > +b.year ? a : b));
  let val = +latest[param];
  if (param === "population") return d3.format(",.0f")(val);
  if (param === "gdp") return d3.format(",.0f")(val);
  if (param === "co2") return d3.format(",.2f")(val);
  if (param === "energy_per_capita") return d3.format(",.0f")(val);
  return val;
}

function updateBasicComparison() {
  const c1 = d3.select("#countryLine1").property("value");
  const c2 = d3.select("#countryLine2").property("value");
  const year = d3.select("#yearSelect").property("value");
  const boxHtml = [c1, c2].map(country => `
    <div class="basic-box">
      <h3>${country}</h3>
      ${basicParams.map(p => `
        <div class="param-row">
          <span class="param-label">${p.label}</span>
          <span class="param-value">${getLatestValue(co2DataGlobal, country, p.key, year)}</span>
        </div>
      `).join("")}
    </div>
  `).join("");
  d3.select("#basicComparison").html(boxHtml);
}

// --- 10. Animacija kroz godine ---

function startAnimation() {
  if (isAnimating) return;
  isAnimating = true;
  d3.select("#play-animation").text("Zaustavi animaciju");
  const startYear = +d3.select("#yearSelect").property("value");
  let currentYear = startYear;
  animationInterval = setInterval(() => {
    if (currentYear >= 2020) {
      stopAnimation();
      return;
    }
    currentYear++;
    d3.select("#yearSelect").property("value", currentYear);
    updateMap(currentYear);
  }, 1000);
}

function stopAnimation() {
  if (!isAnimating) return;
  clearInterval(animationInterval);
  isAnimating = false;
  d3.select("#play-animation").text("Pokreni animaciju");
}

function toggleAnimation() {
  if (isAnimating) {
    stopAnimation();
  } else {
    startAnimation();
  }
}

// --- 11. Povezivanje kontrola i događaja ---

d3.select("#zoom-in").on("click", () => {
  svgMap.transition().call(zoom.scaleBy, 1.5);
});
d3.select("#zoom-out").on("click", () => {
  svgMap.transition().call(zoom.scaleBy, 0.5);
});
d3.select("#zoom-reset").on("click", resetZoom);
d3.select("#play-animation").on("click", toggleAnimation);

// --- 12. Učitavanje podataka i inicijalizacija aplikacije ---

Promise.all([
  d3.json("geo/europe.geojson"),
  d3.csv("data/owid-co2-data.csv")
]).then(([geoData, co2Data]) => {
  geoDataGlobal = geoData;
  co2DataGlobal = co2Data;
  europeanCountries = geoData.features.map(d => nameMap[d.properties.NAME] || d.properties.NAME);

  // Popunjavanje izbornika godina i država
  const validYears = Array.from(new Set(co2Data.map(d => +d.year))).filter(y => y >= 1990 && y <= 2022).sort((a,b)=>a-b);
  const yearSelect = d3.select("#yearSelect");
  const countryLine1 = d3.select("#countryLine1");
  const countryLine2 = d3.select("#countryLine2");

  validYears.forEach(y => yearSelect.append("option").attr("value", y).text(y));
  europeanCountries.sort().forEach(c => {
    countryLine1.append("option").attr("value", c).text(c);
    countryLine2.append("option").attr("value", c).text(c);
  });

  // Inicijalni prikaz
  const defaultYear = 2010;
  yearSelect.property("value", defaultYear);
  updateMap(defaultYear);
  updateBarChart(defaultYear);

  // Event listeneri za izbornike
  yearSelect.on("change", function () {
    if (isAnimating) stopAnimation();
    updateMap(+this.value);
    updateBarChart(+this.value);
    updateBasicComparison();
  });

  countryLine1.on("change", () => {
    updateLineChart(countryLine1.property("value"), countryLine2.property("value"));
    updateBasicComparison();
  });
  countryLine2.on("change", () => {
    updateLineChart(countryLine1.property("value"), countryLine2.property("value"));
    updateBasicComparison();
  });

  updateLineChart("Albania", "Albania");
  updateBasicComparison();
});

// Funkcije za sidebar
function openCountrySidebar(countryName) {
  d3.select("#selectedCountryName").text(`Detalji: ${countryName}`);
  d3.select("#countrySidebar").classed("open", true);
  
  // Generiraj grafove za odabranu državu
  updateSourcesPieChart(countryName);
  updatePerCapitaChart(countryName);
  updateCumulativeChart(countryName);
  updateGhgChart(countryName);
}

function closeCountrySidebar() {
  d3.select("#countrySidebar").classed("open", false);
}

// Pie chart 
function updateSourcesPieChart(country) {
  const svg = d3.select("#sourcesPieChart");
  svg.selectAll("*").remove();
  
  const currentYear = +d3.select("#yearSelect").property("value");
  const countryData = co2DataGlobal.find(d => d.country === country && +d.year === currentYear);
  
  if (!countryData) {
    svg.append("text")
      .attr("x", 225).attr("y", 125)
      .style("text-anchor", "middle")
      .style("font-size", "14px")
      .style("fill", "#666")
      .text("Nema podataka za odabranu godinu");
    return;
  }
  
  const sources = [
    {name: "Ugljen", value: +countryData.coal_co2 || 0, color: "#8B4513"},
    {name: "Plin", value: +countryData.gas_co2 || 0, color: "#4169E1"},
    {name: "Nafta", value: +countryData.oil_co2 || 0, color: "#228B22"},
    {name: "Cement", value: +countryData.cement_co2 || 0, color: "#888888"},
    {name: "Ostalo", value: +countryData.other_industry_co2 || 0, color: "#FF6347"}
  ].filter(d => d.value > 0);
  
  if (sources.length === 0) {
    svg.append("text")
      .attr("x", 225).attr("y", 125)
      .style("text-anchor", "middle")
      .style("font-size", "14px")
      .style("fill", "#666")
      .text("Nema emisija za prikaz");
    return;
  }
  
  const width = 450, height = 250;
  const radius = Math.min(width, height) / 2 - 80; 
  const g = svg.append("g").attr("transform", `translate(${width/2},${height/2})`);
  
  const pie = d3.pie()
    .value(d => d.value)
    .sort(null)
    .padAngle(0.02);
  
  const arc = d3.arc()
    .innerRadius(0)
    .outerRadius(radius);
  
  const outerArc = d3.arc()
    .innerRadius(radius * 1.5)
    .outerRadius(radius * 1.5);
  
  const arcs = g.selectAll(".arc")
    .data(pie(sources))
    .enter().append("g").attr("class", "arc");
  
  // Animacija pie segmenata
  arcs.append("path")
    .attr("d", arc)
    .attr("fill", d => d.data.color)
    .attr("stroke", "white")
    .attr("stroke-width", 2)
    .style("opacity", 0)
    .transition()
    .duration(800)
    .delay((d, i) => i * 150)
    .style("opacity", 1)
    .attrTween("d", function(d) {
      const interpolate = d3.interpolate({startAngle: 0, endAngle: 0}, d);
      return function(t) {
        return arc(interpolate(t));
      };
    });
  
  // Anti-collision algoritam za labele
  setTimeout(() => {
    const pieData = pie(sources);
    
    const labelData = pieData.map(d => {
      const midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
      const pos = outerArc.centroid(d);
      pos[0] = radius * 1.6 * (midangle < Math.PI ? 1 : -1);
      return {
        ...d,
        midangle: midangle,
        pos: pos,
        originalY: pos[1],
        side: midangle < Math.PI ? 'right' : 'left'
      };
    });
    
    const leftLabels = labelData.filter(d => d.side === 'left').sort((a, b) => a.pos[1] - b.pos[1]);
    const rightLabels = labelData.filter(d => d.side === 'right').sort((a, b) => a.pos[1] - b.pos[1]);
    
    function avoidCollision(labels) {
      const minDistance = 20; 
      
      for (let i = 1; i < labels.length; i++) {
        const current = labels[i];
        const previous = labels[i - 1];
        
        if (current.pos[1] - previous.pos[1] < minDistance) {
          current.pos[1] = previous.pos[1] + minDistance;
        }
      }
      
      const maxY = height / 2 - 20;
      const minY = -height / 2 + 20;
      
      for (let i = labels.length - 1; i >= 0; i--) {
        if (labels[i].pos[1] > maxY) {
          labels[i].pos[1] = maxY - (labels.length - 1 - i) * minDistance;
        }
        if (labels[i].pos[1] < minY) {
          labels[i].pos[1] = minY + i * minDistance;
        }
      }
    }
    
   
    avoidCollision(leftLabels);
    avoidCollision(rightLabels);
    
    const finalLabelData = [...leftLabels, ...rightLabels];
    
    // Dodaj linije i labele
    finalLabelData.forEach((d, i) => {
      const arcData = arcs.data().find(arcD => arcD.data.name === d.data.name);
      const arcElement = arcs.filter(arcD => arcD.data.name === d.data.name);
      
      const posA = arc.centroid(d); 
      const posB = outerArc.centroid(d); 
      const posC = [d.pos[0], d.pos[1]]; 
      
      arcElement.append("polyline")
        .attr("opacity", 0)
        .attr("stroke", "#666")
        .attr("stroke-width", 1)
        .attr("fill", "none")
        .attr("points", [posA, posB, posC])
        .transition()
        .duration(500)
        .delay(i * 100)
        .attr("opacity", 0.8);
      
      // Label tekst
      arcElement.append("text")
        .attr("opacity", 0)
        .attr("dy", "0.35em")
        .style("text-anchor", d.side === 'right' ? 'start' : 'end')
        .attr("transform", `translate(${d.pos[0]}, ${d.pos[1]})`)
        .style("font-size", "11px")
        .style("font-weight", "bold")
        .style("fill", "#333")
        .text(`${d.data.name}: ${d.data.value.toFixed(1)} Mt`)
        .transition()
        .duration(500)
        .delay(i * 100)
        .attr("opacity", 1);
    });
  }, 1200);
  
  // Tooltip na segmente
  setTimeout(() => {
    arcs.selectAll("path")
      .style("cursor", "pointer")
      .on("mouseover", (event, d) => {
        const totalValue = d3.sum(sources, s => s.value);
        const percentage = ((d.data.value / totalValue) * 100).toFixed(1);
        
        tooltip.transition().duration(200).style("opacity", .9);
        tooltip.html(`
          <strong>${d.data.name}</strong><br>
          ${d.data.value.toFixed(2)} Mt CO₂<br>
          ${percentage}% ukupno
        `)
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 60) + "px");
        
        // Highlight effect
        d3.select(event.currentTarget)
          .transition()
          .duration(200)
          .attr("transform", "scale(1.05)")
          .style("filter", "brightness(1.1)");
      })
      .on("mouseout", (event, d) => {
        tooltip.transition().duration(500).style("opacity", 0);
        
        // Remove highlight
        d3.select(event.currentTarget)
          .transition()
          .duration(200)
          .attr("transform", "scale(1)")
          .style("filter", "brightness(1)");
      });
  }, 1700);
}

// Line chart za CO2 per capita
function updatePerCapitaChart(country) {
  const svg = d3.select("#perCapitaChart");
  svg.selectAll("*").remove();
  
  const margin = {top: 20, right: 20, bottom: 60, left: 70};
  const width = 450 - margin.left - margin.right;
  const height = 250 - margin.top - margin.bottom;
  
  const data = co2DataGlobal
    .filter(d => d.country === country && !isNaN(+d.co2_per_capita) && +d.year >= 1990)
    .map(d => ({year: +d.year, value: +d.co2_per_capita}))
    .sort((a, b) => a.year - b.year);
  
  if (data.length === 0) {
    svg.append("text")
      .attr("x", 225).attr("y", 125)
      .style("text-anchor", "middle")
      .style("font-size", "14px")
      .style("fill", "#666")
      .text("Nema podataka za CO₂ per capita");
    return;
  }
  
  const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
  
  const x = d3.scaleLinear().domain(d3.extent(data, d => d.year)).range([0, width]);
  const y = d3.scaleLinear().domain([0, d3.max(data, d => d.value)]).nice().range([height, 0]);
  
  const line = d3.line()
    .x(d => x(d.year))
    .y(d => y(d.value))
    .curve(d3.curveMonotoneX);
  
  // Osi s labelima
  g.append("g")
    .attr("transform", `translate(0,${height})`)
    .call(d3.axisBottom(x).tickFormat(d3.format("d")))
    .append("text")
    .attr("x", width / 2)
    .attr("y", 40)
    .attr("fill", "black")
    .style("text-anchor", "middle")
    .style("font-size", "12px")
    .text("Godina");
  
  g.append("g")
    .call(d3.axisLeft(y).tickFormat(d => d.toFixed(1) + " t"))
    .append("text")
    .attr("transform", "rotate(-90)")
    .attr("y", -50)
    .attr("x", -height / 2)
    .attr("fill", "black")
    .style("text-anchor", "middle")
    .style("font-size", "12px")
    .text("CO₂ per capita (t/osobi)");
  
  // Animacija linije
  const path = g.append("path")
    .datum(data)
    .attr("fill", "none")
    .attr("stroke", "#1f77b4")
    .attr("stroke-width", 2)
    .attr("d", line);
  
  const totalLength = path.node().getTotalLength();
  path
    .attr("stroke-dasharray", totalLength + " " + totalLength)
    .attr("stroke-dashoffset", totalLength)
    .transition()
    .duration(1000)
    .ease(d3.easeLinear)
    .attr("stroke-dashoffset", 0);

  // KREIRAJ ili SELEKTIRAJ postojeći tooltip
  let tooltip = d3.select("#chart-tooltip");
  if (tooltip.empty()) {
    tooltip = d3.select("body")
      .append("div")
      .attr("id", "chart-tooltip")
      .style("position", "absolute")
      .style("padding", "10px")
      .style("background", "rgba(0, 0, 0, 0.8)")
      .style("color", "white")
      .style("border-radius", "5px")
      .style("pointer-events", "none")
      .style("font-size", "12px")
      .style("opacity", 0)
      .style("z-index", 1000);
  }
  
 
  const dots = g.selectAll(".dot")
    .data(data)
    .enter().append("circle")
    .attr("class", "dot")
    .attr("cx", d => x(d.year))
    .attr("cy", d => y(d.value))
    .attr("r", 0) 
    .attr("fill", "#1f77b4")
    .attr("stroke", "white")
    .attr("stroke-width", 1)
    .style("cursor", "pointer")
    .on("mouseover", function(event, d) {
      console.log("Mouseover triggered!", d); 
      tooltip.transition()
        .duration(200)
        .style("opacity", 1);
      tooltip.html(`
        <strong>${country}</strong><br>
        <strong>Godina:</strong> ${d.year}<br>
        <strong>CO₂:</strong> ${d.value.toFixed(2)} t/osobi
      `)
        .style("left", (event.pageX + 10) + "px")
        .style("top", (event.pageY - 60) + "px");
    })
    .on("mouseout", function() {
      console.log("Mouseout triggered!"); 
      tooltip.transition()
        .duration(500)
        .style("opacity", 0);
    })
    .on("mousemove", function(event) {
      tooltip
        .style("left", (event.pageX + 10) + "px")
        .style("top", (event.pageY - 60) + "px");
    });
  
  // ANIMACIJA veličine točaka
  dots.transition()
    .duration(300)
    .delay((d, i) => i * 15 + 1000)
    .attr("r", 3);
}


// Area chart za kumulativne emisije
function updateCumulativeChart(country) {
  const svg = d3.select("#cumulativeChart");
  svg.selectAll("*").remove();
  
  const margin = {top: 20, right: 20, bottom: 60, left: 70};
  const width = 450 - margin.left - margin.right;
  const height = 250 - margin.top - margin.bottom;
  
  const data = co2DataGlobal
    .filter(d => d.country === country && !isNaN(+d.cumulative_co2) && +d.year >= 1990)
    .map(d => ({year: +d.year, value: +d.cumulative_co2}))
    .sort((a, b) => a.year - b.year);
  
  if (data.length === 0) {
    svg.append("text")
      .attr("x", 225).attr("y", 125)
      .style("text-anchor", "middle")
      .style("font-size", "14px")
      .style("fill", "#666")
      .text("Nema podataka za kumulativne emisije");
    return;
  }
  
  const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
  
  const x = d3.scaleLinear().domain(d3.extent(data, d => d.year)).range([0, width]);
  const y = d3.scaleLinear().domain([0, d3.max(data, d => d.value)]).nice().range([height, 0]);
  
  // Osi s labelima
  g.append("g")
    .attr("transform", `translate(0,${height})`)
    .call(d3.axisBottom(x).tickFormat(d3.format("d")))
    .append("text")
    .attr("x", width / 2)
    .attr("y", 40)
    .attr("fill", "black")
    .style("text-anchor", "middle")
    .style("font-size", "12px")
    .text("Godina");
  
  g.append("g")
    .call(d3.axisLeft(y).tickFormat(d => `${d3.format(".1s")(d)}t`))
    .append("text")
    .attr("transform", "rotate(-90)")
    .attr("y", -50)
    .attr("x", -height / 2)
    .attr("fill", "black")
    .style("text-anchor", "middle")
    .style("font-size", "12px")
    .text("Kumulativni CO₂ (Mt)");
  
  const area = d3.area()
    .x(d => x(d.year))
    .y0(height)
    .y1(d => y(d.value))
    .curve(d3.curveMonotoneX);
  
  // Animacija area-e
  const areaPath = g.append("path")
    .datum(data)
    .attr("fill", "rgba(31, 119, 180, 0.3)")
    .attr("stroke", "#1f77b4")
    .attr("stroke-width", 2)
    .attr("d", area);
  
  // Mask za animaciju
  const maskId = "mask-" + Math.random().toString(36).substr(2, 9);
  const mask = svg.append("defs")
    .append("mask")
    .attr("id", maskId);
  
  mask.append("rect")
    .attr("x", 0)
    .attr("y", 0)
    .attr("width", 0)
    .attr("height", height + margin.top + margin.bottom)
    .attr("fill", "white")
    .transition()
    .duration(2500)
    .attr("width", width + margin.left + margin.right);
  
  areaPath.attr("mask", `url(#${maskId})`);
}

// Horizontal bar chart za stakleničke plinove
function updateGhgChart(country) {
  const svg = d3.select("#ghgChart");
  svg.selectAll("*").remove();
  
  const currentYear = +d3.select("#yearSelect").property("value");
  const countryData = co2DataGlobal.find(d => d.country === country && +d.year === currentYear);
  
  if (!countryData) {
    svg.append("text")
      .attr("x", 225).attr("y", 125)
      .style("text-anchor", "middle")
      .style("font-size", "14px")
      .style("fill", "#666")
      .text("Nema podataka za stakleničke plinove");
    return;
  }
  
  const ghgData = [
    {name: "CO₂", value: +countryData.co2 || 0, color: "#1f77b4", unit: "Mt"},
    {name: "Metan", value: (+countryData.methane || 0), color: "#ff7f0e", unit: "Mt CO₂-ekv"},
    {name: "N₂O", value: (+countryData.nitrous_oxide || 0), color: "#2ca02c", unit: "Mt CO₂-ekv"}
  ].filter(d => d.value > 0);
  
  if (ghgData.length === 0) {
    svg.append("text")
      .attr("x", 225).attr("y", 125)
      .style("text-anchor", "middle")
      .style("font-size", "14px")
      .style("fill", "#666")
      .text("Nema podataka o plinovima");
    return;
  }
  
  const margin = {top: 20, right: 100, bottom: 60, left: 100}; 
  const width = 450 - margin.left - margin.right;
  const height = 250 - margin.top - margin.bottom;
  
  const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
  
  
  const maxValue = d3.max(ghgData, d => d.value);
  const x = d3.scaleLinear()
    .domain([0, maxValue * 1.1]) 
    .range([0, width]);
  
  const y = d3.scaleBand()
    .domain(ghgData.map(d => d.name))
    .range([0, height])
    .padding(0.3);
  
  
  g.append("g")
    .call(d3.axisLeft(y).tickSize(0).tickPadding(10))
    .selectAll("text")
    .style("font-size", "12px")
    .style("font-weight", "bold");
  
  // X os s pametnijim formatiranjem ovisno o veličini brojeva
  let tickFormat;
  if (maxValue > 1000) {
    tickFormat = d => (d / 1000).toFixed(1) + "k"; // Za velike brojeve
  } else if (maxValue > 100) {
    tickFormat = d => d.toFixed(0); 
  } else {
    tickFormat = d => d.toFixed(1); 
  }
  
  g.append("g")
    .attr("transform", `translate(0,${height})`)
    .call(d3.axisBottom(x)
      .ticks(5) // Samo 5 tick-ova da nije zakrčeno
      .tickFormat(tickFormat)
    )
    .selectAll("text")
    .style("font-size", "11px");
  
  // Label za X os
  g.append("text")
    .attr("x", width / 2)
    .attr("y", height + 45)
    .attr("fill", "black")
    .style("text-anchor", "middle")
    .style("font-size", "12px")
    .style("font-weight", "bold")
    .text("Emisije (Mt CO₂-ekvivalent)");
  
  // Animacija stupaca
  const bars = g.selectAll(".bar")
    .data(ghgData)
    .enter().append("rect")
    .attr("class", "bar")
    .attr("y", d => y(d.name))
    .attr("height", y.bandwidth())
    .attr("x", 0)
    .attr("width", 0)
    .attr("fill", d => d.color)
    .attr("rx", 3) 
    .style("cursor", "pointer")
    .transition()
    .duration(800)
    .delay((d, i) => i * 200)
    .attr("width", d => x(d.value));
  
 
  setTimeout(() => {
    g.selectAll(".label")
      .data(ghgData)
      .enter().append("text")
      .attr("class", "label")
      .attr("x", d => x(d.value) + 8)
      .attr("y", d => y(d.name) + y.bandwidth()/2)
      .attr("dy", "0.35em")
      .style("font-size", "11px")
      .style("font-weight", "bold")
      .style("fill", "#333")
      .style("opacity", 0)
      .text(d => {
        // Pametniji prikaz brojeva
        if (d.value >= 1000) {
          return `${(d.value/1000).toFixed(1)}k Mt`;
        } else if (d.value >= 100) {
          return `${d.value.toFixed(0)} Mt`;
        } else {
          return `${d.value.toFixed(1)} Mt`;
        }
      })
      .transition()
      .duration(400)
      .style("opacity", 1);
  }, 1000);
  
  // Tooltip s detaljnijim informacijama
  setTimeout(() => {
    g.selectAll(".bar")
      .on("mouseover", (event, d) => {
        // Highlight bar
        d3.select(event.currentTarget)
          .transition()
          .duration(200)
          .style("opacity", 0.8)
          .attr("stroke", "#333")
          .attr("stroke-width", 2);
          
        tooltip.transition().duration(200).style("opacity", .9);
        tooltip.html(`
          <strong>${d.name}</strong><br>
          <strong>Emisije:</strong> ${d.value.toFixed(2)} Mt<br>
          <strong>Godina:</strong> ${currentYear}<br>
          <strong>Država:</strong> ${country}
        `)
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 70) + "px");
      })
      .on("mouseout", (event, d) => {
        // Remove highlight
        d3.select(event.currentTarget)
          .transition()
          .duration(200)
          .style("opacity", 1)
          .attr("stroke", "none");
          
        tooltip.transition().duration(500).style("opacity", 0);
      });
  }, 1000);
}

// Event listener za zatvaranje na ESC
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeCountrySidebar();
  }
});

  </script>
</body>
</html>